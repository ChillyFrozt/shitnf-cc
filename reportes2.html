<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reporte de Pagos - Casa Campus</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>

    <!-- BOTÓN VOLVER -->
    <button class="btnVolver"><a href="reportes.html">Volver</a></button>

    <!-- BOTÓN IMPRIMIR -->
    <button class="btnImprimir" id="btnImprimir"><span>Imprimir / PDF</span></button>

    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="navbar__container">
            <a href="/home.html"><img id="navbar__logo" src="images/logo.png" alt="Logo" /></a>
            <div class="navbar__toggle" id="mobile-menu">
                <span class="bar"></span><span class="bar"></span><span class="bar"></span>
            </div>
            <ul class="navbar__menu">
                <li class="navbar__item"><a href="/inquilinos.html" class="navbar__links">Inquilinos</a></li>
                <li class="navbar__item"><a href="/pagos.html" class="navbar__links">Pagos</a></li>
                <li class="navbar__item"><a href="/reportes.html" class="navbar__links">Reportes</a></li>
                <li class="navbar__btn"><a href="/login.html" class="navbar__button">Iniciar Sesión</a></li>
            </ul>
        </div>
    </nav>

    <div class="template_container">
        <div class="reportes_wrapper">
            <h1 style="text-align:center;margin:12px 0 20px;">Reporte General de Inquilinos y Pagos</h1>

            <div id="ok" class="alert ok"></div>
            <div id="err" class="alert err"></div>

            <table>
                <colgroup>
                    <col />
                    <col />
                    <col />
                    <col />
                    <col />
                    <col />
                </colgroup>
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Cuarto</th>
                        <th>Teléfono</th>
                        <th>Cédula</th>
                        <th>Último pago</th>
                        <th>Próximo vencimiento</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>

    <div class="footer_container">
        <div class="social__media--wrap">
            <img id="footer_logo" src="images/logo.png" />
        </div>
        <p class="website__rights">© Casa Campus TEC 2025. Derechos Reservados</p>
    </div>

    <script>
        const API = 'http://localhost:3001';
        const $ = s => document.querySelector(s);

        const ok = $('#ok');
        const err = $('#err');
        const tbody = $('#tbody');

        const showOK = t => { ok.textContent = t; ok.style.display = 'block'; setTimeout(() => ok.style.display = 'none', 2000); };
        const showERR = t => { err.textContent = t; err.style.display = 'block'; setTimeout(() => err.style.display = 'none', 3500); };

        const fmtDate = (iso) => {
            if (!iso) return '—';
            const d = new Date(iso);
            if (isNaN(d)) return '—';
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        };

        const addMonths = (iso, months = 1) => {
            const d = new Date(iso);
            if (isNaN(d)) return null;
            const day = d.getDate();
            d.setMonth(d.getMonth() + months);
            if (d.getDate() < day) d.setDate(0);
            return d.toISOString().slice(0, 10);
        };

        const fmtUSD = (n) => {
            if (n == null) return '—';
            const num = Number(n);
            if (isNaN(num)) return '—';
            return `$${num.toFixed(2)} USD`;
        };

        async function api(path, opts = {}) {
            const res = await fetch(API + path, { headers: { 'Content-Type': 'application/json' }, ...opts });
            const txt = await res.text();
            if (!res.ok) throw new Error(`${res.status} ${res.statusText} - ${txt || 'sin cuerpo'}`);
            try { return txt ? JSON.parse(txt) : null; } catch { return null; }
        }

        function ultimoPagoPorCuarto(cuarto, payments) {
            const lista = payments.filter(p => (p.cuarto || '').toUpperCase() === (cuarto || '').toUpperCase());
            if (lista.length === 0) return null;
            lista.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            return lista[0];
        }

        async function cargarReporte() {
            try {
                const [tenants, payments] = await Promise.all([
                    api('/tenants'),
                    api('/payments')
                ]);

                const rows = tenants.map(t => {
                    const up = ultimoPagoPorCuarto(t.cuarto, payments);
                    const lastAmount = up?.monto ?? null;
                    const lastDate = up?.fecha ?? null;
                    const nextDueISO = lastDate ? addMonths(lastDate, 1) : null;

                    let estado = '';
                    if (nextDueISO) {
                        const hoyISO = new Date().toISOString().slice(0, 10);
                        if (hoyISO > nextDueISO) estado = ' (atrasado)';
                    }

                    return `
          <tr>
            <td>${t.nombre}</td>
            <td>${t.cuarto}</td>
            <td>${t.telefono}</td>
            <td>${t.cedula}</td>
            <td>${lastAmount ? `${fmtUSD(lastAmount)} · ${fmtDate(lastDate)}` : 'Sin pagos'}</td>
            <td>${nextDueISO ? `${fmtDate(nextDueISO)}${estado}` : '—'}</td>
          </tr>
        `;
                });

                tbody.innerHTML = rows.join('');
                showOK('Reporte generado');
            } catch (e) {
                console.error(e);
                showERR('No se pudo generar el reporte');
            }
        }

        $('#btnImprimir').addEventListener('click', () => window.print());
        cargarReporte();
    </script>
    <script src="auth.js"></script>
</body>

</html>